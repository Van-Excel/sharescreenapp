<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Agent</title>
</head>
<body>
  <h1>Agent Page</h1>
  <button id="generateLink">Generate Session Link</button>
  <div id="linkOutput" style="margin:10px 0; font-weight:bold;"></div>
  <video id="video" autoplay playsinline></video>

  <script>
    console.log("Agent JS running");

    const protocol = location.protocol === "https:" ? "wss://" : "ws://";
    const ws = new WebSocket(protocol + location.host);
    let pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });
    let sessionId = null;

    pc.ontrack = (event) => {
      console.log("Agent received stream");
      const videoEl = document.getElementById("video");
      if (videoEl.srcObject !== event.streams[0]) {
        videoEl.srcObject = event.streams[0];
      }
    };

    pc.onicecandidate = (event) => {
      console.log("Agent ICE candidate:", event.candidate);
      if (event.candidate) {
        ws.send(JSON.stringify({ type: "ice", candidate: event.candidate, sessionId }));
      }
    };

    ws.onopen = () => {
      console.log("WebSocket connected (agent)");
    };

    document.getElementById("generateLink").onclick = () => {
      sessionId = Math.random().toString(36).substring(2, 8);
      const url = location.origin + "/customer.html?session=" + sessionId;
      document.getElementById("linkOutput").innerText = url;

      ws.send(JSON.stringify({ type: "register", role: "agent", sessionId }));
    };

    ws.onmessage = async (event) => {
      const text = event.data instanceof Blob ? await event.data.text() : event.data;
      const data = JSON.parse(text);
      console.log("Agent received:", data);

      if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type: "answer", answer, sessionId }));
      }

      if (data.type === "ice" && data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };
  </script>
</body>
</html>
